<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adrian Kommunikator PRO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f0f0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Landscape-Modus erzwingen */
        @media (orientation: portrait) {
            .rotate-hint {
                display: flex !important;
            }
            .app-container {
                display: none !important;
            }
        }

        .rotate-hint {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2196F3;
            color: white;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            z-index: 9999;
        }

        .rotate-hint .icon {
            font-size: 80px;
            animation: rotate 2s infinite;
            margin-bottom: 20px;
        }

        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
        }

        /* Header */
        .header {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .header button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Anzeige-Bereich */
        .display-area {
            background: #e3f2fd;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            border-bottom: 2px solid #bbdefb;
        }

        .display-text {
            flex: 1;
            font-size: 28px;
            font-weight: bold;
            color: #333;
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        .display-actions {
            display: flex;
            gap: 10px;
        }

        .btn-action {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-action:active {
            transform: scale(0.9);
        }

        .btn-speak {
            background: #4CAF50;
            color: white;
        }

        .btn-clear {
            background: #f44336;
            color: white;
        }

        /* Haupt-Grid */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .kachel {
            aspect-ratio: 1;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .kachel:active {
            transform: scale(0.95);
        }

        .kachel.aktiv {
            border-color: #333;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .kachel.unterordner::after {
            content: 'üìÅ';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 20px;
            background: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kachel-inhalt {
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
            pointer-events: none;
        }

        .kachel-icon {
            font-size: 50px;
            margin-bottom: 5px;
        }

        .kachel-text {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        /* Farben */
        .farbe-orange { background-color: #FF9800; }
        .farbe-blau { background-color: #2196F3; }
        .farbe-gelb { background-color: #FFEB3B; }
        .farbe-hellblau { background-color: #03A9F4; }
        .farbe-gruen { background-color: #4CAF50; }
        .farbe-rosa { background-color: #E91E63; }
        .farbe-rot { background-color: #f44336; }
        .farbe-lila { background-color: #9C27B0; }
        .farbe-braun { background-color: #795548; }
        .farbe-grau { background-color: #9E9E9E; }

        .farbe-gelb .kachel-inhalt,
        .farbe-hellblau .kachel-inhalt {
            color: #333;
        }

        /* Zur√ºck-Button */
        .zurueck-btn {
            background: #666;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .breadcrumb {
            padding: 0 20px 10px;
            color: #666;
            font-size: 14px;
        }

        /* Einstellungen-Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.aktiv {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #333;
        }

        .btn-schliessen {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .einstellung-gruppe {
            margin-bottom: 25px;
        }

        .einstellung-gruppe h3 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .einstellung-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .einstellung-item label {
            font-weight: bold;
            color: #555;
        }

        select, input[type="range"], input[type="color"] {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            min-width: 150px;
        }

        input[type="range"] {
            width: 150px;
        }

        .foto-upload {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .foto-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .foto-item label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }

        .foto-item input[type="file"] {
            width: 100%;
            margin-bottom: 10px;
        }

        .foto-preview {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin: 0 auto;
            display: block;
            border: 2px solid #ddd;
        }

        .btn-speichern {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .btn-speichern:hover {
            background: #45a049;
        }

        /* Unterordner-Ansicht */
        .unterordner-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .unterordner-kachel {
            aspect-ratio: 1;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
        }

        .unterordner-kachel:active {
            transform: scale(0.95);
        }

        .unterordner-kachel .inhalt {
            background: rgba(255,255,255,0.95);
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
        }

        /* Hilfe-Text */
        .hilfe-text {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 14px;
        }

        /* Vollbild-Kamera */
        .kamera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 2000;
            flex-direction: column;
        }

        .kamera-modal.aktiv {
            display: flex;
        }

        #kamera-video {
            flex: 1;
            object-fit: cover;
        }

        .kamera-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            background: #333;
        }

        .btn-kamera {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: #f44336;
            cursor: pointer;
        }

        .btn-kamera:active {
            transform: scale(0.9);
        }
    </style>
</head>
<body>
    <!-- Hinweis zum Drehen -->
    <div class="rotate-hint">
        <div class="icon">üì±</div>
        <h2>Bitte Handy drehen</h2>
        <p>Die App funktioniert am besten im Querformat.<br>Bitte drehe dein Handy horizontal.</p>
    </div>

    <!-- Haupt-App -->
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>üß∏ <span id="titel-text">Adrian sagt</span></h1>
            <div class="header-buttons">
                <button onclick="kameraOeffnen()">üì∑ Foto</button>
                <button onclick="einstellungenOeffnen()">‚öôÔ∏è Einstellungen</button>
            </div>
        </div>

        <!-- Breadcrumb -->
        <div class="breadcrumb" id="breadcrumb">Hauptmen√º</div>

        <!-- Anzeige -->
        <div class="display-area">
            <div class="display-text" id="anzeige">Tippe auf ein Bild...</div>
            <div class="display-actions">
                <button class="btn-action btn-speak" onclick="vorlesen()" title="Vorlesen">üîä</button>
                <button class="btn-action btn-clear" onclick="loeschen()" title="L√∂schen">üóëÔ∏è</button>
            </div>
        </div>

        <!-- Haupt-Inhalt -->
        <div class="main-content" id="haupt-content">
            <div class="grid-container" id="grid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>
    </div>

    <!-- Einstellungen Modal -->
    <div class="modal" id="einstellungen-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Einstellungen</h2>
                <button class="btn-schliessen" onclick="einstellungenSchliessen()">√ó</button>
            </div>

            <div class="einstellung-gruppe">
                <h3>üé® Aussehen</h3>
                <div class="einstellung-item">
                    <label>Kachel-Gr√∂√üe</label>
                    <input type="range" id="kachel-groesse" min="100" max="250" value="150" onchange="speichernEinstellung('kachelGroesse', this.value)">
                </div>
                <div class="einstellung-item">
                    <label>Rand-Rundung</label>
                    <input type="range" id="kachel-rundung" min="0" max="50" value="20" onchange="speichernEinstellung('kachelRundung', this.value)">
                </div>
                <div class="einstellung-item">
                    <label>Schatten-St√§rke</label>
                    <select id="schatten-staerke" onchange="speichernEinstellung('schatten', this.value)">
                        <option value="kein">Kein Schatten</option>
                        <option value="leicht" selected>Leicht</option>
                        <option value="stark">Stark</option>
                    </select>
                </div>
            </div>

            <div class="einstellung-gruppe">
                <h3>üîä Sprache</h3>
                <div class="einstellung-item">
                    <label>Geschwindigkeit</label>
                    <input type="range" id="sprach-geschwindigkeit" min="0.3" max="1.5" step="0.1" value="0.8" onchange="speichernEinstellung('geschwindigkeit', this.value)">
                </div>
                <div class="einstellung-item">
                    <label>Stimme</label>
                    <select id="stimme-auswahl" onchange="speichernEinstellung('stimme', this.value)">
                        <option value="default">Standard</option>
                    </select>
                </div>
            </div>

            <div class="einstellung-gruppe">
                <h3>‚ö° Verhalten</h3>
                <div class="einstellung-item">
                    <label>Aktivierung</label>
                    <select id="aktivierung" onchange="speichernEinstellung('aktivierung', this.value)">
                        <option value="klick">Einfacher Klick</option>
                        <option value="halten" selected>Langes Dr√ºcken (0.5s)</option>
                        <option value="doppel">Doppelklick</option>
                    </select>
                </div>
                <div class="einstellung-item">
                    <label>Sofort vorlesen</label>
                    <select id="sofort-vorlesen" onchange="speichernEinstellung('sofortVorlesen', this.value)">
                        <option value="ja" selected>Ja</option>
                        <option value="nein">Nein (nur bei üîä)</option>
                    </select>
                </div>
            </div>

            <div class="einstellung-gruppe">
                <h3>üñºÔ∏è Eigene Bilder</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    W√§hle eigene Fotos aus deiner Galerie:
                </p>
                <div class="foto-upload">
                    <div class="foto-item">
                        <label>üçé Essen</label>
                        <input type="file" accept="image/*" onchange="bildHochladen(this, 'essen')">
                        <img class="foto-preview" id="preview-essen" style="display:none;">
                    </div>
                    <div class="foto-item">
                        <label>ü•õ Trinken</label>
                        <input type="file" accept="image/*" onchange="bildHochladen(this, 'trinken')">
                        <img class="foto-preview" id="preview-trinken" style="display:none;">
                    </div>
                    <div class="foto-item">
                        <label>üöΩ WC</label>
                        <input type="file" accept="image/*" onchange="bildHochladen(this, 'wc')">
                        <img class="foto-preview" id="preview-wc" style="display:none;">
                    </div>
                    <div class="foto-item">
                        <label>üõÅ Baden</label>
                        <input type="file" accept="image/*" onchange="bildHochladen(this, 'baden')">
                        <img class="foto-preview" id="preview-baden" style="display:none;">
                    </div>
                    <div class="foto-item">
                        <label>üß∏ Spielen</label>
                        <input type="file" accept="image/*" onchange="bildHochladen(this, 'spielen')">
                        <img class="foto-preview" id="preview-spielen" style="display:none;">
                    </div>
                    <div class="foto-item">
                        <label>üë© Mama</label>
                        <input type="file" accept="image/*" onchange="bildHochladen(this, 'mama')">
                        <img class="foto-preview" id="preview-mama" style="display:none;">
                    </div>
                </div>
            </div>

            <button class="btn-speichern" onclick="alleEinstellungenSpeichern()">üíæ Alle Einstellungen speichern</button>
        </div>
    </div>

    <!-- Kamera Modal -->
    <div class="kamera-modal" id="kamera-modal">
        <video id="kamera-video" autoplay playsinline></video>
        <div class="kamera-controls">
            <button class="btn-kamera" onclick="fotoMachen()"></button>
            <button onclick="kameraSchliessen()" style="background:white; padding:10px 20px; border-radius:10px; border:none;">Abbrechen</button>
        </div>
        <canvas id="kamera-canvas" style="display:none;"></canvas>
    </div>

    <script>
        // === DATENSTRUKTUR ===
        
        // Hauptkategorien mit Unterordnern
        const struktur = {
            haupt: [
                { 
                    id: 'essen', 
                    text: 'Essen', 
                    icon: 'üçé', 
                    farbe: 'farbe-orange',
                    unterordner: [
                        { id: 'apfel', text: 'Apfel', icon: 'üçé' },
                        { id: 'banane', text: 'Banane', icon: 'üçå' },
                        { id: 'brot', text: 'Brot', icon: 'üçû' },
                        { id: 'milch', text: 'Milch', icon: 'ü•õ' },
                        { id: 'kekse', text: 'Kekse', icon: 'üç™' },
                        { id: 'wurst', text: 'Wurst', icon: 'üå≠' }
                    ]
                },
                { 
                    id: 'trinken', 
                    text: 'Trinken', 
                    icon: 'ü•õ', 
                    farbe: 'farbe-blau',
                    unterordner: [
                        { id: 'wasser', text: 'Wasser', icon: 'üíß' },
                        { id: 'saft', text: 'Saft', icon: 'üßÉ' },
                        { id: 'milch', text: 'Milch', icon: 'ü•õ' },
                        { id: 'tee', text: 'Tee', icon: 'üçµ' }
                    ]
                },
                { 
                    id: 'wc', 
                    text: 'WC', 
                    icon: 'üöΩ', 
                    farbe: 'farbe-gelb',
                    unterordner: [
                        { id: 'pipi', text: 'Pipi machen', icon: 'üíß' },
                        { id: 'pupu', text: 'Pupu machen', icon: 'üí©' },
                        { id: 'abwischen', text: 'Abwischen', icon: 'üßª' },
                        { id: 'haende', text: 'H√§nde waschen', icon: 'üßº' }
                    ]
                },
                { 
                    id: 'baden', 
                    text: 'Baden', 
                    icon: 'üõÅ', 
                    farbe: 'farbe-hellblau',
                    unterordner: [
                        { id: 'badewanne', text: 'In Badewanne', icon: 'üõÅ' },
                        { id: 'duschen', text: 'Duschen', icon: 'üöø' },
                        { id: 'haare', text: 'Haare waschen', icon: 'üß¥' },
                        { id: 'zaehne', text: 'Z√§hne putzen', icon: 'ü™•' }
                    ]
                },
                { 
                    id: 'spielen', 
                    text: 'Spielen', 
                    icon: 'üß∏', 
                    farbe: 'farbe-gruen',
                    unterordner: [
                        { id: 'ball', text: 'Ball', icon: '‚öΩ' },
                        { id: 'auto', text: 'Auto', icon: 'üöó' },
                        { id: 'bauen', text: 'Bauen', icon: 'üß±' },
                        { id: 'malen', text: 'Malen', icon: 'üé®' },
                        { id: 'musik', text: 'Musik', icon: 'üéµ' },
                        { id: 'draussen', text: 'Drau√üen', icon: 'üå≥' }
                    ]
                },
                { 
                    id: 'mama', 
                    text: 'Mama', 
                    icon: 'üë©', 
                    farbe: 'farbe-rosa',
                    unterordner: [
                        { id: 'umarmung', text: 'Umarmung', icon: 'ü§ó' },
                        { id: 'kuss', text: 'Kuss', icon: 'üíã' },
                        { id: 'helfen', text: 'Hilfe', icon: 'üÜò' },
                        { id: 'schlafen', text: 'Schlafen legen', icon: 'üõèÔ∏è' }
                    ]
                },
                { 
                    id: 'weh', 
                    text: 'Tut weh', 
                    icon: 'üö®', 
                    farbe: 'farbe-rot',
                    unterordner: [
                        { id: 'kopf', text: 'Kopf', icon: 'ü§ï' },
                        { id: 'bauch', text: 'Bauch', icon: 'üò£' },
                        { id: 'arm', text: 'Arm/Bein', icon: 'ü¶µ' },
                        { id: 'krank', text: 'Ich bin krank', icon: 'ü§í' }
                    ]
                },
                { 
                    id: 'mehr', 
                    text: 'Mehr', 
                    icon: '‚ûï', 
                    farbe: 'farbe-lila',
                    unterordner: [
                        { id: 'ja', text: 'Ja', icon: 'üëç' },
                        { id: 'nein', text: 'Nein', icon: 'üëé' },
                        { id: 'bitte', text: 'Bitte', icon: 'üôè' },
                        { id: 'danke', text: 'Danke', icon: 'üòä' },
                        { id: 'fertig', text: 'Fertig', icon: '‚úÖ' },
                        { id: 'pause', text: 'Pause', icon: '‚è∏Ô∏è' }
                    ]
                }
            ]
        };

        // === ZUSTAND ===
        let aktuellerPfad = ['haupt'];
        let aktuellerSatz = '';
        let letzteKachel = null;
        let einstellungen = {};
        let eigeneBilder = {};

        // === INITIALISIERUNG ===
        window.onload = function() {
            ladeEinstellungen();
            ladeEigeneBilder();
            zeigeGrid();
            ladeStimmen();
        };

        // === GRID ANZEIGEN ===
        function zeigeGrid() {
            const grid = document.getElementById('grid');
            const breadcrumb = document.getElementById('breadcrumb');
            const titel = document.getElementById('titel-text');
            
            grid.innerHTML = '';
            
            // Breadcrumb aktualisieren
            const pfadText = aktuellerPfad.map(p => {
                if (p === 'haupt') return 'Hauptmen√º';
                const item = findeItem(p);
                return item ? item.text : p;
            }).join(' ‚Üí ');
            breadcrumb.textContent = pfadText;
            
            // Zur√ºck-Button wenn nicht im Hauptmen√º
            if (aktuellerPfad.length > 1) {
                const zurueckBtn = document.createElement('button');
                zurueckBtn.className = 'zurueck-btn';
                zurueckBtn.innerHTML = '‚Üê Zur√ºck';
                zurueckBtn.onclick = zurueck;
                grid.appendChild(zurueckBtn);
                
                // Grid f√ºr Unterordner
                const unterordnerGrid = document.createElement('div');
                unterordnerGrid.className = 'unterordner-grid';
                unterordnerGrid.style.gridColumn = '1 / -1';
                
                const aktuellerOrdner = findeItem(aktuellerPfad[aktuellerPfad.length - 1]);
                if (aktuellerOrdner && aktuellerOrdner.unterordner) {
                    aktuellerOrdner.unterordner.forEach(item => {
                        const kachel = erstelleUnterordnerKachel(item, aktuellerOrdner.farbe);
                        unterordnerGrid.appendChild(kachel);
                    });
                }
                
                grid.appendChild(unterordnerGrid);
            } else {
                // Hauptmen√º
                struktur.haupt.forEach(item => {
                    const kachel = erstelleHauptKachel(item);
                    grid.appendChild(kachel);
                });
            }
        }

        function findeItem(id) {
            for (let kat of struktur.haupt) {
                if (kat.id === id) return kat;
                if (kat.unterordner) {
                    for (let sub of kat.unterordner) {
                        if (sub.id === id) return sub;
                    }
                }
            }
            return null;
        }

        function erstelleHauptKachel(item) {
            const kachel = document.createElement('div');
            kachel.className = `kachel ${item.farbe} ${item.unterordner ? 'unterordner' : ''}`;
            
            // Eigenes Bild?
            const eigenesBild = eigeneBilder[item.id];
            if (eigenesBild) {
                kachel.style.backgroundImage = `url(${eigenesBild})`;
                kachel.innerHTML = `<div class="kachel-inhalt"><div class="kachel-text">${item.text}</div></div>`;
            } else {
                kachel.innerHTML = `
                    <div class="kachel-inhalt">
                        <div class="kachel-icon">${item.icon}</div>
                        <div class="kachel-text">${item.text}</div>
                    </div>
                `;
            }
            
            kachel.onclick = function() {
                if (item.unterordner) {
                    aktuellerPfad.push(item.id);
                    zeigeGrid();
                } else {
                    waehlen(`Ich will ${item.text}`, kachel);
                }
            };
            
            return kachel;
        }

        function erstelleUnterordnerKachel(item, parentFarbe) {
            const kachel = document.createElement('div');
            kachel.className = `unterordner-kachel ${parentFarbe}`;
            
            const eigenesBild = eigeneBilder[item.id];
            if (eigenesBild) {
                kachel.style.backgroundImage = `url(${eigenesBild})`;
            }
            
            kachel.innerHTML = `<div class="inhalt">${item.icon}<br>${item.text}</div>`;
            
            kachel.onclick = function() {
                const parent = findeItem(aktuellerPfad[aktuellerPfad.length - 1]);
                waehlen(`Ich will ${item.text} ${parent.text}`, kachel);
            };
            
            return kachel;
        }

        function zurueck() {
            if (aktuellerPfad.length > 1) {
                aktuellerPfad.pop();
                zeigeGrid();
            }
        }

        // === AUSWAHL & SPRACHE ===
        function waehlen(text, element) {
            aktuellerSatz = text;
            document.getElementById('anzeige').textContent = text;
            
            // Visuelles Feedback
            if (letzteKachel) {
                letzteKachel.classList.remove('aktiv');
            }
            if (element) {
                element.classList.add('aktiv');
                letzteKachel = element;
            }
            
            // Vibration
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // Sofort vorlesen?
            if (einstellungen.sofortVorlesen !== 'nein') {
                setTimeout(vorlesen, 200);
            }
        }

        function vorlesen() {
            if (!aktuellerSatz) return;
            
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(aktuellerSatz);
            utterance.lang = 'de-DE';
            utterance.rate = parseFloat(einstellungen.geschwindigkeit || 0.8);
            utterance.pitch = 1.0;
            
            if (einstellungen.stimme) {
                const stimmen = window.speechSynthesis.getVoices();
                const gewaehlteStimme = stimmen.find(s => s.name === einstellungen.stimme);
                if (gewaehlteStimme) utterance.voice = gewaehlteStimme;
            }
            
            window.speechSynthesis.speak(utterance);
        }

        function loeschen() {
            aktuellerSatz = '';
            document.getElementById('anzeige').textContent = 'Tippe auf ein Bild...';
            if (letzteKachel) {
                letzteKachel.classList.remove('aktiv');
                letzteKachel = null;
            }
        }

        // === EINSTELLUNGEN ===
        function einstellungenOeffnen() {
            document.getElementById('einstellungen-modal').classList.add('aktiv');
            
            // Vorschau-Bilder laden
            for (let key in eigeneBilder) {
                const preview = document.getElementById(`preview-${key}`);
                if (preview) {
                    preview.src = eigeneBilder[key];
                    preview.style.display = 'block';
                }
            }
        }

        function einstellungenSchliessen() {
            document.getElementById('einstellungen-modal').classList.remove('aktiv');
        }

        function speichernEinstellung(key, value) {
            einstellungen[key] = value;
            localStorage.setItem('adrian_einstellungen', JSON.stringify(einstellungen));
            wendeEinstellungenAn();
        }

        function ladeEinstellungen() {
            const gespeichert = localStorage.getItem('adrian_einstellungen');
            if (gespeichert) {
                einstellungen = JSON.parse(gespeichert);
                wendeEinstellungenAn();
            }
        }

        function wendeEinstellungenAn() {
            // Kachel-Gr√∂√üe
            if (einstellungen.kachelGroesse) {
                document.querySelectorAll('.kachel').forEach(k => {
                    k.style.minHeight = einstellungen.kachelGroesse + 'px';
                });
            }
            
            // Rundung
            if (einstellungen.kachelRundung) {
                document.querySelectorAll('.kachel, .unterordner-kachel').forEach(k => {
                    k.style.borderRadius = einstellungen.kachelRundung + 'px';
                });
            }
            
            // Schatten
            if (einstellungen.schatten) {
                const schattenWerte = {
                    'kein': 'none',
                    'leicht': '0 4px 15px rgba(0,0,0,0.2)',
                    'stark': '0 8px 25px rgba(0,0,0,0.3)'
                };
                document.querySelectorAll('.kachel').forEach(k => {
                    k.style.boxShadow = schattenWerte[einstellungen.schatten] || schattenWerte['leicht'];
                });
            }
        }

        function alleEinstellungenSpeichern() {
            alert('‚úì Einstellungen gespeichert!');
            einstellungenSchliessen();
            zeigeGrid(); // Neu rendern
        }

        // === BILDER ===
        function bildHochladen(input, kategorie) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                eigeneBilder[kategorie] = e.target.result;
                localStorage.setItem('adrian_bilder', JSON.stringify(eigeneBilder));
                
                // Vorschau anzeigen
                const preview = document.getElementById(`preview-${kategorie}`);
                if (preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }

        function ladeEigeneBilder() {
            const gespeichert = localStorage.getItem('adrian_bilder');
            if (gespeichert) {
                eigeneBilder = JSON.parse(gespeichert);
            }
        }

        // === KAMERA ===
        let kameraStream = null;

        function kameraOeffnen() {
            const modal = document.getElementById('kamera-modal');
            const video = document.getElementById('kamera-video');
            
            modal.classList.add('aktiv');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    kameraStream = stream;
                    video.srcObject = stream;
                })
                .catch(err => {
                    alert('Kamera nicht verf√ºgbar: ' + err.message);
                    kameraSchliessen();
                });
        }

        function fotoMachen() {
            const video = document.getElementById('kamera-video');
            const canvas = document.getElementById('kamera-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const bildData = canvas.toDataURL('image/png');
            
            // Fragen f√ºr welche Kategorie
            const kategorie = prompt('F√ºr welche Kategorie? (essen, trinken, wc, baden, spielen, mama):');
            if (kategorie && struktur.haupt.find(k => k.id === kategorie)) {
                eigeneBilder[kategorie] = bildData;
                localStorage.setItem('adrian_bilder', JSON.stringify(eigeneBilder));
                alert('‚úì Foto gespeichert f√ºr: ' + kategorie);
            }
            
            kameraSchliessen();
        }

        function kameraSchliessen() {
            const modal = document.getElementById('kamera-modal');
            modal.classList.remove('aktiv');
            
            if (kameraStream) {
                kameraStream.getTracks().forEach(track => track.stop());
                kameraStream = null;
            }
        }

        // === STIMMEN ===
        function ladeStimmen() {
            const select = document.getElementById('stimme-auswahl');
            const stimmen = window.speechSynthesis.getVoices();
            
            // Deutsche Stimmen filtern
            const deutscheStimmen = stimmen.filter(s => s.lang.startsWith('de'));
            
            deutscheStimmen.forEach(stimme => {
                const option = document.createElement('option');
                option.value = stimme.name;
                option.textContent = stimme.name;
                select.appendChild(option);
            });
        }

        // Stimmen k√∂nnen verz√∂gert geladen werden
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = ladeStimmen;
        }

        // === TASTATUR ===
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('einstellungen-modal').classList.contains('aktiv')) {
                    einstellungenSchliessen();
                } else if (aktuellerPfad.length > 1) {
                    zurueck();
                } else {
                    loeschen();
                }
            }
            if (e.key === ' ') vorlesen();
        });
    </script>
</body>
</html>
